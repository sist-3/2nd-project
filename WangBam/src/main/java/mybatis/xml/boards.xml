<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="borads">

<!-- rersultMap -->
	<!-- 게시글 작성자 + 댓글 목록 -->
	<resultMap type="mybatis.vo.BoardVO" id="rm1">
		<id property="bo_idx" column="bo_idx"/>
		<association property="uvo" javaType="mybatis.vo.UserVO" select="user" column="us_idx"/>
		<association property="pvo" javaType="mybatis.vo.ProductVO" select="product" column="pd_idx"/>
		<collection property="c_list" ofType="mybatis.vo.CommVO" select="comment.comment" column="bo_idx"/>
	</resultMap>
	
	<resultMap type="mybatis.vo.CommentVO" id="getUser">
		<id property="co_idx" column="co_idx"/>
		<collection property="uvo" ofType="mybatis.vo.UserVO" select="user" column="us_idx"/>
	</resultMap>
	
<!-- resultMap end -->

<!-- Select -->
	<!-- 조회할 게시글 + 검색조건 + 작성자 + 댓글 + 상품 -->
	<select id="list" parameterType="String" resultType="rm1"> 
		SELECT *
		FROM (
        	SELECT @RN:=@RN+1 AS rnum, a.*
        	FROM (
            	SELECT *
            	FROM boards_t
            	WHERE bo_status = 1 AND bo_type = #{bo_type}
            	ORDER BY bo_idx DESC
        	) a, (SELECT @RN:=0) b
    	) c
		<where>
			c.rnum BETWEEN #{begin} AND #{end}
			<if test="searchType != null and searchValue != null">
				<choose>
					<when test= "searchType == title"> <!-- 제목 검색 -->
						bo_title LIKE CONCAT('%',#{searchValue},'%')
					</when>
					<when test= "searchType == writer"> <!-- 작성자 검색 -->
						us_idx in (select us_idx from user_t where us_name like concat('%', #{searchValue}, '%'))
					</when>
					<when test= "searchType == writeDate"> <!-- 날짜 검색 -->
						bo_write_date BETWEEN #{searchValue} and #{searchValue2}
					</when>
					<when test= "searchType == score"> <!-- 평점 검색 -->
						bo_score = #{searchValue}
					</when>
					<when test= "searchType == answer"> <!-- 미답변 목록 검색 -->
						bo_answer = 1
					</when>
				</choose>
			</if>
		</where>
	</select>
	
	<!-- 게시글, 댓글을 작성한 유저 정보 -->
	<select id="user" parameterType="String" resultType="mybatis.vo.UserVO">
		SELECT *
		FROM user_t
		WHERE us_idx = #{us_idx}
	</select>
	
	<!-- 게시글에 올라간 상품 정보 -->
	<select id="product" parameterType="String" resultType="mybatis.vo.ProductVO">
		SELECT *
		FROM product_t
		WHERE pd_idx = #{pd_idx}
	</select>
	
	<!-- 게시글 상세보기 -->
	<select id="view" parameterType="String" resultType="mybatis.vo.BoardVO">
		SELECT *
		FROM boards_t
		WHERE bo_idx = #{bo_idx}
	</select>
<!-- Select end -->

<!-- Insert -->
	<!-- 게시글 작성 -->
	<insert id="write" parameterType="map">
		INSERT INTO boards_t
			(us_idx, pd_idx, bo_type, bo_title, bo_content, bo_write_date, bo_img, bo_score, bo_answer, bo_status)
		VALUES
			(#{us_idx}, #{pd_idx}, #{bo_type}, #{bo_title}, #{bo_content}, NOW(), #{bo_img}, #{bo_score}, 0, #{bo_status})
	</insert>
<!-- Insert end -->

<!-- Update, Delete -->
	<!-- 작성된 게시글 수정 -->
	<update id="edit" parameterType="map">
		UPDATE boards_t
		SET	us_idx = #{us_idx}, pd_idx = #{pd_idx}, bo_type = #{bo_type}, bo_title = #{bo_title}, bo_content = #{bo_content},
			bo_write_date = NOW(), bo_img = #{bo_img}, bo_score = #{bo_score}, bo_answer = #{bo_answer}
		WHERE bo_idx = #{bo_idx}
	</update>
	
	<!-- 게시글 삭제 -->
	<update id="delete" parameterType="String">
		UPDATE boards_t
		SET bo_status = 0
		WHERE bo_idx = #{bo_idx}
	</update>
	
	<!-- 조회수 증가 -->
	<update id="hit" parameterType="String">
		UPDATE boards_t
		SET hit = hit+1
		WHERE bo_idx = #{bo_idx}
	</update>
	
	<!-- 문의사항 게시글에 관리자가 답변을 작성 -->
	<update id="answer">
		UPDATE boards_t
		SET bo_answer = 0
		WHERE bo_idx = #{bo_idx}
	</update>
<!-- Update, Delete end-->

</mapper>